const { Client } = require('pg');

module.exports = async function (context, IoTHubMessages) {
  const table = process.env.db_table;
  const config = {
    host: process.env.db_hostname,
    user: process.env.db_username,
    password: process.env.db_password,
    database: process.env.db_name,
    port: 5432,
    ssl: true
  };

  const client = new Client(config);

  try {
    await client.connect();

    const payload = JSON.parse(IoTHubMessages);
    context.log(`Payload: ${JSON.stringify(payload)}`);

    const values = [
      payload[0].data,
      payload[1].data,
      payload[2].data,
      payload[3].data
    ];

    const query = `INSERT INTO ${table} (di_, ai_, do_, ao_, time_, id_) VALUES ($1, $2, $3, $4, DEFAULT, DEFAULT)`;

    await client.query(query, values);
    context.log("Data inserted into the database successfully.");
  } catch (error) {
    context.log(`Error inserting data into the database: ${error}`);
  } finally {
    await client.end();
  }

  context.log("Finished running");
};
